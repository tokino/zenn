---
title: "AWS CDKã‚’ä½¿ã£ã¦Lightsail Containerã«ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹æ–¹æ³•"
emoji: "ğŸ”–"
type: "tech"
topics: ["AWS", "AWSCDK", "IaC", "Lightsail"]
published: true
published_at: 2023-02-04 12:00
publication_name: "d2cid_inc"
---

## ã¯ã˜ã‚ã«

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¤ã„ã¦ã¯[åˆ¥è¨˜äº‹](https://zenn.dev/kinosan/articles/4608ec4f3b984a)ã§æ›¸ã„ã¦ã„ã‚‹ã®ã§æœ¬è¨˜äº‹ã§ã¯å‰²æ„›ã€‚

### è¨¼æ˜æ›¸ã®ç™ºè¡Œ

#### Stackã®å®šç¾©

æœ€ä½é™å¿…è¦ãªæƒ…å ±ã¨ã—ã¦ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

```typescript
import * as cdk from "aws-cdk-lib";

export class CdkExampleStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new cdk.aws_lightsail.CfnCertificate(this, "cdk-example-certificate", {
      certificateName: "cdk-example-certificate",
      domainName: "cdk-example.com",
    });
  }
}
```

`cdk-example-certificate`ã¯ä¸€æ„ãªIDã¨ã—ã¦ã®æŒ‡å®šã«ãªã‚‹ãŸã‚æ­£ç›´ãªã‚“ã§ã‚‚ã„ã„ã€‚  
ç¬¬3å¼•æ•°ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«`subjectAlternativeNames`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ä»–ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’å«ã‚ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚  
æŒ‡å®šã§ãã‚‹å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è©³ç´°ã¯[å…¬å¼ã®CloudFormationã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lightsail-certificate.html)ã‚’è¦‹ãŸæ–¹ãŒæ—©ã„ã€‚

#### Stackã®ãƒ‡ãƒ—ãƒ­ã‚¤

æ¬¡ã¯å®šç¾©ã—ãŸStackã‚’cliã§deployã‚’ã™ã‚‹ã€‚ ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

```bash
cdk deploy --profile ${ç”¨æ„ã—ãŸprofileå}
```

å®Ÿè¡Œå¾Œã«ç‰¹ã«ã‚¨ãƒ©ãƒ¼ã‚‰ã—ãå‡ºåŠ›ãŒç„¡ã‘ã‚Œã°æ­£å¸¸ã«çµ‚ã‚ã£ã¦ã„ã‚‹ã€‚  
ã“ã‚Œã§lightsailä¸Šã«è¨¼æ˜æ›¸ã®ç”¨æ„ãŒã§ããŸãŒã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã‹ã‚‰ã¯è¨¼æ˜æ›¸ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ããªã„ã€‚ ãŸã ã—ã€AWS CLIã§ã¯ç¢ºèªãŒã§ãã‚‹ã®ã§ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§è¨¼æ˜æ›¸ã®æƒ…å ±ã‚’ç¢ºèªã™ã‚‹ã€‚  

```bash
aws lightsail get-certificates --certificate-name cdk-example-certificate --profile ${ç”¨æ„ã—ãŸprofileå} \
| jq '.certificates[].certificateDetail.domainValidationRecords'
```

æ­£å¸¸ã«çµ‚äº†ã™ã‚Œã°ACMã§è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ãŸæ™‚ã¨åŒæ§˜ã«DNSã«ç™»éŒ²ã™ã‚‹ãŸã‚ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå–å¾—ã§ãã‚‹ã€‚  
å–å¾—ã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’DNSã«ç™»éŒ²ã—ã¦èªè¨¼ãŒé€šã‚Œã°è¨¼æ˜æ›¸ã®ä½œæ¥­ã¯å®Œäº†ã«ãªã‚‹ã€‚

## è¨¼æ˜æ›¸ã¨ã‚³ãƒ³ãƒ†ãƒŠã‚µãƒ¼ãƒ“ã‚¹ã®ç¹‹ãè¾¼ã¿

### ã‚³ãƒ³ãƒ†ãƒŠã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ
è¨¼æ˜æ›¸ã®ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒŠã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆã™ã‚‹ã€‚  
è¨¼æ˜æ›¸ã®å®šç¾©ã‚’ã—ã¦ã„ã‚‹CdkExampleStackã‚¯ãƒ©ã‚¹å†…ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚³ãƒ³ãƒ†ãƒŠã‚µãƒ¼ãƒ“ã‚¹ã®å®šç¾©ã‚’è¿½åŠ ã™ã‚‹ã€‚

```typescript
    new cdk.aws_lightsail.CfnContainer(this, 'cdk-example-container', {
      power: 'nano',
      scale: 1,
      serviceName: 'cdk-example-container',
      containerServiceDeployment: {
        containers: [{
          containerName: 'cdk-example-container',
          image: 'public.ecr.aws/nginx/nginx:stable',
          ports: [
            {
              port: '80',
              protocol: 'HTTP'
            }
          ],
        }],
        publicEndpoint: {
          containerName: 'cdk-example-container',
          containerPort: 80,
          healthCheckConfig: {
            healthyThreshold: 2,
            unhealthyThreshold: 2,
            timeoutSeconds: 2,
            intervalSeconds: 5,
            path: '/',
            successCodes: "200-499"
          }
        }
      }
    });
```
CfnContainerã‚¯ãƒ©ã‚¹ã®ç¬¬2å¼•æ•°ã¯IDã«ãªã‚‹ã®ã§ä»»æ„ã®å€¤ã‚’è¨­å®šã™ã‚Œã°è‰¯ã„ã€‚  
ç¬¬3å¼•æ•°ã§è¨­å®šã—ã¦ã„ã‚‹`serviceName`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã‚µãƒ¼ãƒ“ã‚¹ã®åå‰ã«ãªã‚‹ã€‚  
ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã®åå‰ã¯`containerServiceDeployment`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å†…ã§å®šç¾©ã—ã¦ã„ã‚‹`containers`ã®`containerName`ãŒè©²å½“ã™ã‚‹ã€‚
ã“ã®åå‰ã¯å¤–éƒ¨ã¸å…¬é–‹ã™ã‚‹ãŸã‚ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‹ã‚‰ç–é€šã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã«åˆ©ç”¨ã™ã‚‹ã€‚

ã“ã“ã§diffã‚’å–ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ä½œæˆå¯¾è±¡ã¨ã—ã¦å‡ºã¦ãã‚‹ã€‚
```text
Resources
[+] AWS::Lightsail::Container cdk-example-container cdkexamplecontainer 
```

ãã¡ã‚“ã¨diffã®å¯¾è±¡ã¨ã—ã¦å‡ºã¦ããŸã‚‰è¨¼æ˜æ›¸ã®ä½œæˆæ™‚åŒæ§˜ã«Stackã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ã€‚

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã™ã‚‹ã¨Lightsailãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¿ãƒ–ã§ã‚µãƒ¼ãƒ“ã‚¹ã®å­˜åœ¨ãŒç¢ºèªã§ãã‚‹ã€‚  
ã“ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒLBã‹ã‚‰ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãŒé€šã‚‰ãªã„ã¨å®Œäº†ã—ãªã„ãŸã‚æ™‚é–“ãŒã‹ã‹ã‚‹ãŒã€å­˜åœ¨ãŒç¢ºèªã§ããŸæ®µéšã§ä¸€å¿œã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ãƒšãƒ¼ã‚¸ã«ã¯ç§»å‹•ãŒã§ãã‚‹ã€‚  
è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã„ã£ãŸã‚¿ãƒ–ãŒä¸¦ã‚“ã§ã„ã‚‹ä¸­ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã„ã†ã‚¿ãƒ–ãŒã‚ã‚‹ã®ãŒç¢ºèªã§ãã‚‹ã€‚  
ã“ã®ã‚¿ãƒ–ã«ç§»å‹•ã™ã‚‹ã¨*è¨¼æ˜æ›¸ã‚’ã‚¢ã‚¿ãƒƒãƒ*ã¨ã„ã†ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã€ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒçµ‚ã‚ã£ã¦ã„ã‚Œã°ãã‚Œã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å…ˆã»ã©ä½œæˆã—ãŸè¨¼æ˜æ›¸ãŒã‚ã‚‹ã®ãŒç¢ºèªã§ãã‚‹ã€‚  
ã‚‚ã—ã‚‚ç„¡ã„å ´åˆã¯*è¨¼æ˜æ›¸ã‚’ã‚¢ã‚¿ãƒƒãƒ*ã®ä¸‹ã«ã‚ã‚‹*ä¿ç•™ä¸­ã®è¨¼æ˜æ›¸*ã§ç¢ºèªãŒã§ãã‚‹ã€‚

### ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®è¨¼æ˜æ›¸ã®è¨­å®š

ã‚µãƒ¼ãƒ“ã‚¹ã«è¨¼æ˜æ›¸ã‚’è¨­å®šã™ã‚‹å ´åˆã¯`publicDomainNames`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨­å®šã™ã‚‹ã€‚  
è¨­å®šå†…å®¹ä¾‹ã¯ä»¥ä¸‹ã®å†…å®¹ã‚’å‚ç…§ã€‚
```typescript
      publicDomainNames: [{
        certificateName: 'cdk-example-certificate',
        domainNames: ['cdk-example.com']
      }]
```

`certificateName`ã«åˆ©ç”¨ã™ã‚‹å…ˆã»ã©ä½œæˆã—ãŸè¨¼æ˜æ›¸ã®`certificateName`ã‚’`domainNames`ã«ã¯è¨¼æ˜æ›¸ã§åˆ©ç”¨ã§ãã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¨­å®šã™ã‚‹ã€‚

è¨­å®šå†…å®¹ã®å…±é€šåŒ–ãªã©ã‚’ã™ã‚‹ã¨æœ€çµ‚çš„ãªã‚¹ã‚¿ãƒƒã‚¯å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚
```typescript
export class CdkExampleStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const certificate = new cdk.aws_lightsail.CfnCertificate(this, "cdk-example-certificate", {
      certificateName: "cdk-example-certificate",
      domainName: "cdk-example.com",
    });

    new cdk.aws_lightsail.CfnContainer(this, 'cdk-example-container', {
      power: 'nano',
      scale: 1,
      serviceName: 'cdk-example-container',
      publicDomainNames: [{
        certificateName: certificate.certificateName,
        domainNames: [certificate.domainName]
      }],
      containerServiceDeployment: {
        containers: [{
          containerName: 'cdk-example-container',
          image: 'public.ecr.aws/nginx/nginx:stable',
          ports: [
            {
              port: '80',
              protocol: 'HTTP'
            }
          ],
        }],
        publicEndpoint: {
          containerName: 'cdk-example-container',
          containerPort: 80,
          healthCheckConfig: {
            healthyThreshold: 2,
            unhealthyThreshold: 2,
            timeoutSeconds: 2,
            intervalSeconds: 5,
            path: '/',
            successCodes: "200-499"
          }
        }
      }
    });
  }
}
```

ã“ã®ã‚¹ã‚¿ãƒƒã‚¯ã§diffã‚’ä½œæˆã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªçµæœãŒå–å¾—ã§ãã‚‹ã€‚
```text
Resources
[~] AWS::Lightsail::Container cdk-example-container cdkexamplecontainer 
 â””â”€ [+] PublicDomainNames
     â””â”€ [{"CertificateName":"cdk-example-certificate","DomainNames":["cdk-example.com"]}]
```

diffã®çµæœã‚‚ç‰¹ã«å•é¡ŒãŒç„¡ã‘ã‚Œã°Stackã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ã€‚  
ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã‚‰ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å–å¾—ã—ãŸãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’DNSã«è¨­å®šã‚’è¡Œã„ã€ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã‚Œã°å®Œäº†ã«ãªã‚‹ã€‚

```bash
aws lightsail get-container-services --profile ${ç”¨æ„ã—ãŸprofileå} \
--service-name cdk-example-container \
--query 'containerServices[0].url'
```

## ã•ã„ã”ã«
DNSã®ç¹‹ãè¾¼ã¿ã«ã¤ã„ã¦ã¯Route53ã‚’ä½¿ã£ã¦ã‚‹å ´åˆã«ã¯CDKã§å®šç¾©ã—ã¦ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸã„ã€‚
