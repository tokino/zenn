---
title: "gmail.comã¸é€ä¿¡ã—ãŸãƒ¡ãƒ¼ãƒ«ãŒå¼¾ã‹ã‚Œã¦ã—ã¾ã£ãŸå•é¡Œã®å¯¾å¿œ"
emoji: "ðŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [spf, mail, php]
published: false
---
## ãã£ã‹ã‘
ã‚ã‚‹ã‚µã‚¤ãƒˆã®ãŠå•ã„åˆã‚ã›ã‹ã‚‰å—ä¿¡ç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å±Šã„ãŸã‚Šå±Šã‹ãªã‹ã£ãŸã‚Šã™ã‚‹ã¨ã„ã†é€£çµ¡ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ããŸã€‚

## åŽŸå› 
Return-PathãŒã‚µãƒ¼ãƒã®ãƒ›ã‚¹ãƒˆåã«ãªã£ã¦ã„ãŸãŸã‚SPFãƒ¬ã‚³ãƒ¼ãƒ‰ã¨ãƒžãƒƒãƒã—ãªã‹ã£ãŸã€‚

## å¯¾å¿œ
ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãŒ[mailé–¢æ•°](https://www.php.net/manual/ja/function.mail.php)ã‚’ä½¿ç”¨ã—ã€SMTPã¨ã—ã¦sendmailã‚’åˆ©ç”¨ã—ã¦ã„ãŸãŸã‚ ã€additional_paramsã§fã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ¡ãƒ¼ãƒ«ã®Return-Pathã‚’æŒ‡å®šã—ãŸã€‚

## å®Ÿæ–½ã—ãŸèª¿æŸ»å†…å®¹
### /var/log/maillogã®ç¢ºèª
statãŒSentã§ã¯ãªãã€Service unavailableã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

### SPFãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª
```Bash
dig example.domain TXT +short
```

### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒ¼ãƒ«ã®ç¢ºèª
æ„å›³ã›ãšReturn-PathãŒã‚µãƒ¼ãƒã®ãƒ›ã‚¹ãƒˆåã«ãªã£ã¦ã„ãŸã®ã§ã€Return-Pathã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«å±Šã„ã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«å†…å®¹ã‚’ç¢ºèªã€‚
å®Ÿéš›ã®å†…å®¹ã¯ä»¥ä¸‹ã€‚ï¼ˆãŸã ã—å›ºæœ‰æƒ…å ±ã®éƒ¨åˆ†ã¯é©å½“ã«å·®ã—æ›¿ãˆï¼‰

```
while talking to gmail-smtp-in.l.google.com.:
>>> DATA
<<< 550-5.7.26 This mail is unauthenticated, which poses a security risk to the
<<< 550-5.7.26 sender and Gmail users, and has been blocked. The sender must
<<< 550-5.7.26 authenticate with at least one of SPF or DKIM. For this message,
<<< 550-5.7.26 DKIM checks did not pass and SPF check for [xxxxxxxx
<<< 550-5.7.26 xxxxxxx] did not pass with ip: [xxxxxxx]. The
<<< 550-5.7.26 sender should visit
<<< 550-5.7.26  https://support.google.com/mail/answer/81126#authentication for
<<< 550 5.7.26 instructions on setting up authentication. xxxxxxxxxxxx - gsmtp
554 5.0.0 Service unavailable
```

æç¤ºã•ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ä»¥ä¸‹ã®è¨˜è¼‰ãŒã‚ã£ãŸã®ã§ã€ãŠãã‚‰ãã“ã‚Œã«å¼•ã£ã‹ã‹ã‚Šå§‹ã‚ãŸã‚‚ã®ã¨æ€ã‚ã‚Œã‚‹ã€‚

```text
é‡è¦: 2022 å¹´ 11 æœˆã‚ˆã‚Šã€å€‹äººç”¨ Gmail ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹æ–°è¦ã®é€ä¿¡è€…ã¯ã€
SPF ã¾ãŸã¯ DKIM ã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
Google ã§ã¯ã€æ–°è¦ã®é€ä¿¡è€…ã‹ã‚‰å€‹äººç”¨ Gmail ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå®›ã¦ã®ãƒ¡ãƒ¼ãƒ«ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒã‚§ãƒƒã‚¯ã—ã¦ã€
èªè¨¼ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚èªè¨¼æ–¹æ³•ãŒä¸€ã¤ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã„ãƒ¡ãƒ¼ãƒ«ã¯æ‹’å¦ã•ã‚Œã‚‹ã‹ã€
è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ã«åˆ†é¡žã•ã‚Œã¾ã™ã€‚ã“ã®è¦ä»¶ã¯ã€ã™ã§ã«é€ä¿¡è€…ã§ã‚ã‚‹å ´åˆã¯é©ç”¨ã•ã‚Œã¾ã›ã‚“ã€‚ãŸã ã—ã€çµ„ç¹”ã®ãƒ¡ãƒ¼ãƒ«ã‚’ä¿è­·ã—ã€
ä»Šå¾Œã®èªè¨¼è¦ä»¶ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€å¿…ãš SPF ã¨ DKIM ã‚’è¨­å®šã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
```

### ã¾ã¨ã‚
- ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡è¨­å®šã‚’è¡Œã†å ´åˆã¯Fromã ã‘ã§ãªãã€Return-Pathã‚‚ãã¡ã‚“ã¨è¨­å®šã—ãŸæƒ…å ±ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã¹ã
- ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã‚’è¡Œã†éš›ã«ã¯ãã¡ã‚“ã¨å—ä¿¡å´ã§SPFã®çµæžœãŒPASSã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã¹ã
  - ä»Šå›žã¯SPFçµæžœãŒNeutralã«ãªã£ã¦ã„ãŸ

## å‚è€ƒã‚µã‚¤ãƒˆ
- [ä¸€èˆ¬ç¤¾å›£æ³•äººã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå”ä¼šã®è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«å¯¾ç­–ç·¨](https://salt.iajapan.org/wpmu/anti_spam/admin/tech/explanation/spf/#30)
- [mailé–¢æ•°ã®ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«](https://www.php.net/manual/ja/function.mail.php)
- [mailé–¢æ•°ã§ã®Return-Pathã®è¨­å®š](https://pentan.info/php/mail_returnpath.html)