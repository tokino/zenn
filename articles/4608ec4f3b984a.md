---
title: "AWS CDK + AWS Lightsail Container + Wordpress + GitHub Actionsの環境を作る方法"
emoji: " 🤖"
type: "tech"
topics: ["AWS", "CDK", "IaC"]
published: false
---

## AWS CDKとは
正式名称は`AWS Cloud Development Kit`でライブラリを通してCloudFormationを利用するためのツールです。  
terraformはproviderを通してリソースを直接管理しますが、こちらはCloudFormationを通してリソースを管理します。  
terraformでやるか、CDKを使って使い慣れた言語でリソースを管理するかは個人の嗜好の範疇だと思いますが、AWS ChatBotなどterraformのAWS providerでサポートがまだのリソースについてはCDKで管理をした方がいいかと思います。

## AWS Lightsailとは
決まったマシンパワーのリソースを決まった月額料金で利用するためのバンドルサービスです。
データ転送量など一部の料金については超過してしまった場合にはその分が課金対象となります。
また、[lightsailの料金ページ](https://aws.amazon.com/jp/lightsail/pricing/)を見るとわかりますが、コンテナサービスを利用した料金は仮想サーバを利用するよりも割高になっています。

## Lightsailのコンテナサービスを採用した理由
まずLightsailを使おうの前にOSのサポート期限の問題があった。  
Amazon Linuxを使っていたのでセキュリティサポート自体は2023年6月30日までと[告知](https://aws.amazon.com/jp/blogs/news/update-on-amazon-linux-ami-end-of-life/)されてはいたものの、OSのサポート期限を気にするのは嫌だよねということでコンテナサービスを採用するに至った。  
その上でECSでやるのか、Lightsailでやるのかの話があり、実施予定のスケジュールを考えるとECSを一からキャッチアップするよりは[裏でECSが動いてそうなLightsail](https://lightsail.aws.amazon.com/ls/docs/ja_jp/articles/amazon-lightsail-container-services)の方が早いよねということでLightsailに決まった。

## terraformではなくCDKの理由
個人的にはterraformの方が好きなのだが、実施時期（この時は4月〜5月で対応するスケジュールだった）ではterraformの方ではコンテナサービスの管理ができなかった。   
なので、単純にterraform以外で管理ができるCDKを使うことになった。  
これを書いている2022年9月20日時点は[terraformでも作成ができるようになった](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lightsail_container_service)らしい。

## 最終的な構成
最終的に作成した環境はこんな感じ。  
![](/images/4608ec4f3b984a/lightsail.png)
CloudFrontがLightsail外にいる理由は以下二点。
- この作業が移行作業だったこと
  - すでにCloudFrontで利用済のFQDNは別のCloudFrontに当てれない
- Lightsail外に出した方が色々と設定の取り回しがしやすそうだったこと

構成図にはCI/CDの部分も載せているけども、ここは別枠で記事を書きたい。
というわけで移行はLightsail内の作成のみを載せていく。

## やることリスト
実施する作業レベルとしては以下。
- Lightsailのコンテナサービスで利用する証明書の作成
  - Lightsail外の証明書は参照できないのでLightsail内で作成する必要がある
- データベースの作成
- コンテナサービスの作成
  - イメージの置き場所にもなるので先に箱だけを用意する
  - いつからかECRからも取り込めるようになっているので、イメージの置き場所としてはそっちを利用した方がいいかもしれない
- イメージの作成とpush
- コンテナのデプロイ

## 実際に作成
前置きが長くなってしまったがここからは実際に作成をしていく。
### CDKプロジェクトの作成
#### CDKのインストール
まずは[公式のドキュメント](https://docs.aws.amazon.com/cdk/v2/guide/work-with.html#work-with-prerequisites)に沿ってCDKをインストールをする。
```bash
npm install -g aws-cdk
```
これでcdkコマンドが実行できるようになったはず。
#### CDKプロジェクトの初期化
これも[公式のドキュメント](https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-javascript.html)に沿って行う。  
ただし、プロジェクト名はcdk-example、使う言語はTypeScriptにする。
```bash
mkdir cdk-example
cd cdk-example
cdk init app --language typescript
```
作成が終わると以下のような構造のプロジェクトになっているはず。  
node_modulesや.gitなどのプロジェクトに依存しないものは構造から省いています。
```text
.
├── .gitignore
├── .npmignore
├── README.md
├── bin
│   └── cdk-example.ts
├── cdk.json
├── jest.config.js
├── lib
│   └── cdk-example-stack.ts
├── package-lock.json
├── package.json
├── test
│   └── cdk-example.test.ts
└── tsconfig.json
```
ここで作成された`lib/cdk-example-stack.ts`を改造して証明書の作成を行います。
### 証明書
```typescript
import * as cdk from 'aws-cdk-lib';

export class CdkExampleStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new cdk.aws_lightsail.CfnCertificate(this, 'cdk-example-certificate', {
      certificateName: 'cdk-example-certificate',
      domainName: 'cdk-example.com',
    });
  }
}
```
最低限必要な情報としてはこれだけ。
`cdk-example-certificate`は一意なIDとしての指定になるため正直なんでもいい。
subjectAlternativeNamesを指定することで他のサブドメインを含めることも可能。  
第三引数に指定する各プロパティは[公式のCloudFormationのドキュメント](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lightsail-certificate.html)を見た方が早い。