---
title: "AWS CDK + AWS Lightsail Container + Wordpress + GitHub Actionsの環境を作る方法"
emoji: " 🤖"
type: "tech"
topics: ["AWS", "CDK", "IaC"]
published: false
---

## AWS CDKとは
正式名称は`AWS Cloud Development Kit`でライブラリを通してCloudFormationを利用するためのツールです。  
terraformはproviderを通してリソースを直接管理しますが、こちらはCloudFormationを通してリソースを管理します。  
terraformでやるか、CDKを使って使い慣れた言語でリソースを管理するかは個人の嗜好の範疇だと思いますが、AWS ChatBotなどterraformのAWS providerでサポートがまだのリソースについてはCDKで管理をした方がいいかと思います。

## AWS Lightsailとは
決まったマシンパワーのリソースを決まった月額料金で利用するためのバンドルサービスです。
データ転送量など一部の料金については超過してしまった場合にはその分が課金対象となります。
また、[lightsailの料金ページ](https://aws.amazon.com/jp/lightsail/pricing/)を見るとわかりますが、コンテナサービスを利用した料金は仮想サーバを利用するよりも割高になっています。

## Lightsailのコンテナサービスを採用した理由
まずLightsailを使おうの前にOSのサポート期限の問題があった。  
Amazon Linuxを使っていたのでセキュリティサポート自体は2023年6月30日までと[告知](https://aws.amazon.com/jp/blogs/news/update-on-amazon-linux-ami-end-of-life/)されてはいたものの、OSのサポート期限を気にするのは嫌だよねということでコンテナサービスを採用するに至った。  
その上でECSでやるのか、Lightsailでやるのかの話があり、実施予定のスケジュールを考えるとECSを一からキャッチアップするよりは[裏でECSが動いてそうなLightsail](https://lightsail.aws.amazon.com/ls/docs/ja_jp/articles/amazon-lightsail-container-services)の方が早いよねということでLightsailに決まった。

## terraformではなくCDKの理由
個人的にはterraformの方が好きなのだが、実施時期（この時は4月〜5月で対応するスケジュールだった）ではterraformの方ではコンテナサービスの管理ができなかった。   
なので、単純にlightsailサービス全体をterraform以外で管理ができるCDKを使うことになった。  
これを書いている2022年9月20日時点は[terraformでも作成ができるようになった](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/lightsail_container_service)らしい。

## 最終的な構成
最終的に作成した環境はこんな感じ。  
![](/images/4608ec4f3b984a/lightsail.png)
CloudFrontがLightsail外にいる理由は以下二点。
- この作業が移行作業だったこと
  - すでにCloudFrontで利用済のFQDNは別のCloudFrontに当てれない
- Lightsail外に出した方が色々と設定の取り回しがしやすそうだったこと

構成図にはCI/CDの部分も載せているけども、ここは別枠で記事を書きたい。
というわけで移行はLightsail内の作成のみを載せていく。

## 用意するもの
- node環境
- （あまりよくないけど）AdministratorAccess権限があるaws profile

## やることリスト
実施する作業レベルとしては以下。
- Lightsailのコンテナサービスで利用する証明書の作成
  - Lightsail外の証明書は参照できないのでLightsail内で作成する必要がある
- データベースの作成
- コンテナサービスの作成
  - イメージの置き場所にもなるので先に箱だけを用意する
  - いつからかECRからも取り込めるようになっているので、イメージの置き場所としてはそっちを利用した方がいいかもしれない
- イメージの作成とpush
- コンテナのデプロイ

## 実際に作成
前置きが長くなってしまったがここからは実際に作成をしていく。
### CDKプロジェクトの作成
#### CDKのインストール
まずは[公式のドキュメント](https://docs.aws.amazon.com/cdk/v2/guide/work-with.html#work-with-prerequisites)に沿ってCDKをインストールをする。
```bash
npm install -g aws-cdk
```
これでcdkコマンドが実行できるようになったはず。
#### CDKプロジェクトの初期化
これも[公式のドキュメント](https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-javascript.html)に沿って行う。  
ただし、プロジェクト名はcdk-example、使う言語はTypeScriptにする。
```bash
mkdir cdk-example
cd cdk-example
cdk init app --language typescript
```
作成が終わると以下のような構造のプロジェクトになっているはず。  
node_modulesや.gitなどのプロジェクトに依存しないものは構造から省いています。
```text
.
├── .gitignore
├── .npmignore
├── README.md
├── bin
│   └── cdk-example.ts
├── cdk.json
├── jest.config.js
├── lib
│   └── cdk-example-stack.ts
├── package-lock.json
├── package.json
├── test
│   └── cdk-example.test.ts
└── tsconfig.json
```
続いてCloudFormationのStackが作成できるように以下を実施。
```bash
cdk bootstrap --profile ${用意したprofile名}
```
無事に終わると以下のような出力結果になる。
```text
CDKToolkit: creating CloudFormation changeset...
 ✅  Environment aws://${アカウントID}/us-east-1 bootstrapped.
```
これでリソースが作成できるようになる。
次はプロジェクト配下の`lib/cdk-example-stack.ts`を改造して証明書の作成を行います。
### 証明書の発行
#### Stackの定義
最低限必要な情報としては以下の通り。
```typescript
import * as cdk from 'aws-cdk-lib';

export class CdkExampleStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new cdk.aws_lightsail.CfnCertificate(this, 'cdk-example-certificate', {
      certificateName: 'cdk-example-certificate',
      domainName: 'cdk-example.com',
    });
  }
}
```
`cdk-example-certificate`は一意なIDとしての指定になるため正直なんでもいい。  
第三引数のプロパティに`subjectAlternativeNames`を指定することで他のサブドメインを含めることも可能。  
指定できる各プロパティの詳細は[公式のCloudFormationのドキュメント](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lightsail-certificate.html)を見た方が早い。

#### Stackのデプロイ
続いては定義したStackをcliでdeployをする。  
コマンドは以下の通り。
```bash
cdk deploy --profile ${用意したprofile名}
```
実行後に特にエラーらしき出力が無ければ正常に終わっている。
これでlightsail上に証明書の用意ができたが、コンソール上からは証明書を確認することができない。  
ただし、AWS CLIでは確認ができるので以下コマンドで証明書の情報を確認する。
```bash
aws lightsail get-certificates --certificate-name cdk-example-certificate --profile ${用意したprofile名} --region us-east-1 \
| jq '.certificates[].certificateDetail.domainValidationRecords'
```
正常に終了すればACMで証明書を発行した時と同様にDNSに登録するためのレコードが取得できる。  
取得したレコードをDNSに登録して認証が通れば証明書の作業は完了になる。
### データベースの作成
#### Stackの定義
まずは`lib/cdk-example-stack.ts`をコピーして`lib/cdk-example-database-stack.ts`を作成する。  
中身は以下のように書き換えをする。
```typescript
import * as cdk from 'aws-cdk-lib';

export class CdkExampleDatabaseStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new cdk.aws_lightsail.CfnDatabase(this, 'cdk-example-database', {
      masterDatabaseName: 'cdk_example_database',
      masterUsername: 'user',
      relationalDatabaseBlueprintId: 'mysql_5_7',
      relationalDatabaseBundleId: 'micro_2_0',
      relationalDatabaseName: 'cdk-example-database',
    });
  }
}
```
設定しているプロパティの説明を軽くすると

- masterDatabaseName
  - データベース名
- masterUsername
  - データベースに接続するためのユーザ名
- relationalDatabaseBlueprintId
  - 作成するデータベースに使うシステムの種類とバージョン
- relationalDatabaseBundleId
  - 利用するプラン
- relationalDatabaseName
  - リソースを管理する上での一意なID

という感じになる。  
`relationalDatabaseBlueprintId`は`aws lightsail get-relational-database-blueprints`で、`relationalDatabaseBundleId`は`aws lightsail get-relational-database-bundles`で取得できるIDを指定する。  
他に設定できるプロパティは[公式のドキュメント](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lightsail-database.html)を参照。  
パスワードもstackで定義できるけど今回は定義していない。

これで定義は完了になる。
#### 定義したStackをデプロイ対象に登録
前段のStackの定義をするだけではCDKでのデプロイには含まれない。  
含めるには`bin/cdk-example.ts`を修正する必要がある。
ファイルを開くと以下のようになっているはず。
```typescript
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { CdkExampleStack } from '../lib/cdk-example-stack';

const app = new cdk.App();
new CdkExampleStack(app, 'CdkExampleStack', {
    // コメント省略
});
```
これを
```typescript
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { CdkExampleStack } from '../lib/cdk-example-stack';
import {CdkExampleDatabaseStack} from "../lib/cdk-example-database-stack";

const app = new cdk.App();
new CdkExampleStack(app, 'CdkExampleStack', {});
new CdkExampleDatabaseStack(app, 'CdkExampleDatabaseStack', {});
```
こうする。

やったこととしては、
先ほど作成したStackをインポートしてCDKでデプロイできるように登録をしている。   
Stackで渡している第二引数はCloudFormation上で確認できるStack名になる。
#### Stackのデプロイ　
複数のStackのデプロイになるので、証明書の時とは少しコマンドが変わる。  
具体的には`--all`オプションを追加することになり、以下のようになる。
```bash
cdk deploy --all --profile ${用意したprofile名}
```
実行が完了するまでに少し時間がかかるが、コンソール上で進捗が見えるようになる。  
完了すればコンソールから作成したリソースにアクセスしてデータベースに接続するためのパスワードを確認できるようになる。

### コンテナサービスの作成とデプロイ
流れとしてはデータベースの時と同じ。  
`lib/cdk-example-container-stack.ts`というファイルを以下の内容で作成する。
```typescript
import * as cdk from 'aws-cdk-lib';

export class CdkExampleContainerStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    new cdk.aws_lightsail.CfnContainer(this, 'cdk-example-container', {
      power: 'nano',
      scale: 1,
      serviceName: 'cdk-example-container',
      containerServiceDeployment: {
        containers: [{
          containerName: 'cdk-example-container',
          image: 'wordpress:6',
          ports: [
            {
              port: '80',
              protocol: 'HTTP'
            }
          ],
          environment: [
            {
              variable: 'WORDPRESS_DB_HOST',
              value: '' // 自分で作成したDBのホスト
            },
            {
              variable: 'WORDPRESS_DB_USER',
              value: 'user'
            },
            {
              variable: 'WORDPRESS_DB_PASSWORD',
              value: '' // 自分で作成したDBのパスワード
            },
            {
              variable: 'WORDPRESS_DB_NAME',
              value: 'cdk_example_database'
            },
          ]
        }],
        publicEndpoint: {
          containerName: 'cdk-example-container',
          containerPort: 80,
          healthCheckConfig: {
            healthyThreshold: 2,
            unhealthyThreshold: 2,
            timeoutSeconds: 2,
            intervalSeconds: 5,
            path: '/',
            successCodes: "200-499"
          }
        }
      }
    });
  }
}
```
`power`プロパティには`aws lightsail get-container-service-powers`で取得できる情報を設定する。  
ここで面倒なのが`BlueprintId`などとは違って、`powerId`ではなく`name`を設定することになる。
以降はデータベースの時と同じく`bin/cdk-example.ts`を修正してdeployを実行すればコンテナが動作していないリソースが出来上がる。
